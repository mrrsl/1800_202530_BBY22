<html>
  <head>
    <style>
      :root {
        --accent-color: #fff5fa; /* default accent color */
        --header-font: "Oooh Baby", sans-serif;
        --body-font: "Inria Serif", sans-serif;
      }

      body {
        background-color: #fbf7f8;
        text-align: center;
        font-family: var(--header-font);
        font-size: 30pt;
        padding-bottom: 120px; /* makes sure everything is cleared from the bottom navbar*/
      }

      header {
        background-image: url("../img/lightcoloredbackdrop.png");
        box-shadow: 0 0 60px rgba(78, 22, 45, 0.3);
        padding: 2.5rem 0 0.5rem 0; /* top right bottom left padding*/
      }

      #backarrow {
        position: absolute;
        top: 4rem;
        left: 2rem;
        z-index: 10;
        width: 2rem;
        height: auto;
      }

      /* styles the bottom navbar */
      .bottomnav {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: var(--accent-color);
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
        z-index: 100;
        padding: 1rem 0;
      }

      .bottomnav ul {
        display: flex;
        justify-content: space-around;
        align-items: center;
        margin: 0;
        padding: 0;
        list-style: none;
      }

      .bottomnav li {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-family: var(--body-font);
        font-size: 25pt;
        color: #362830;
      }

      .bottomnav img {
        width: 100px;
        height: auto;
        margin-bottom: 0.5rem;
      }

      /* styles the container of the PROFILE title */
      .wrapperforprofilesection {
        display: flex;
        align-items: flex-start;
        max-width: 200px;
        border: 2px solid #cecece81;
        border-radius: 20px;
        padding: 8px 8px;
        background-color: rgba(255, 255, 255, 0.774);
        margin-left: 1em;
        margin-top: 1em;
      }

      /* styles the PROFILE title itself */
      #profilesectiontitle {
        text-align: left;
        font-family: var(--body-font);
        font-size: 36pt;
        font-weight: bold;
        margin: 0;
      }

      /* styles the profile box with the name and email */
      .profilebox {
        margin-top: 0;
        width: 100%;
        box-shadow: 0 4px 60px rgba(78, 22, 45, 0.568);
        font-family: var(--body-font);
        display: flex;
        flex-direction: column;
        gap: 16px;
        text-align: left;
        max-width: 800px;
        margin: 7px 0 40px 40px; /*top right bottom left padding (the top padding controls the spacing between the profile title and profile box*/
        padding: 24px;
        border: 2px solid #4a2b30;
        border-radius: 16px;
        background-color: #fffdfc;
      }

      /* styles the headings within the profile box: Edit Name:, Edit Email:  */
      #settingstitle {
        font-weight: bold;
        margin-bottom: 4px;
        font-size: 35pt;
        color: #4a2b30;
      }

      /* styles the input boxes within the profile box */
      .profilebox input[type="text"] {
        padding: 10px;
        border: 1.5px solid #b57268;
        border-radius: 8px;
        font-size: 35pt;
        font-family: inherit;
      }

      /* styles the logout button */
      #logoutbutton,
      #editbutton,
      #savebutton {
        border: 2px solid #4a2b30;
        border-radius: 20px;
        font-size: 30pt;
        text-align: left;
        font-family: var(--body-font);
        margin-top: 0.5em;
        width: 190px;
        padding: 20px;
        background-color: var(--accent-color);
        color: #362830;
      }

      /* styles the container for the APPEARANCE title */
      .wrapperforapperancesection {
        display: flex;
        align-items: flex-start;
        max-width: 300px;
        border: 2px solid #cecece81;
        border-radius: 20px;
        padding: 8px 8px;
        background-color: rgba(255, 255, 255, 0.774);
        margin-left: 1em;
        margin-top: 1em;
      }

      /* styles the container for the color wheel; mostly creates the border and spacing */
      .colorpickerwheel {
        display: flex;
        flex-direction: row;
        gap: 8px;
        margin-top: 16px;
        padding: 12px;
        border: 2px solid #b5b5b5;
        border-radius: 12px;
        background-color: rgba(255, 255, 255, 0.8);
        max-width: 300px;
        font-family: var(--body-font);
      }

      /* styles the actual color input itself */
      .colorpickerwheel [type="color"] {
        width: 100%;
        height: 40px;
        border: none;
        padding: 0;
        background: none;
      }

      /* styles the default accent color button */
      #restoreColor {
        font-family: var(--body-font);
        background-color: var(--accent-color);
        color: #362830;
        border: 2px solid #4a2b30;
        border-radius: 20px;
        font-size: 30pt;
        padding: 8px 16px;
        margin-top: -3em;
        margin-right: 2.5em;
        float: right;
      }

      /* styles the font icon beside the Font section with the 3 buttons */
      .fontsection img {
        display: inline-block;
        vertical-align: middle;
        padding: 13px;
        margin-top: -1em;
      }

      /* styles all three font buttons at once */
      .fontbutton {
        height: 100px;
        width: 16%;
        line-height: 1;
        margin: 8px;
        font-size: 20pt;
        border: 1px solid #ccc;
        border-radius: 6px;
        background-color: #f5f5f5;
        white-space: nowrap;
      }

      /* styles the container holding the three buttons to align them in the same row */
      .allfontbuttons {
        display: flex;
        gap: 1em;
        flex-wrap: wrap;
      }

      #fontOptionOne {
        font-family: "Cormorant Garamond", sans-serif;
        font-size: 35pt;
      }

      #fontOptionTwo {
        font-family: "Quicksand Book", sans-serif;
        font-size: 30pt;
      }

      #fontOptionThree {
        font-family: "Oooh Baby", sans-serif;
        font-size: 28pt;
      }

      .profilepicwrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 20px 0;
      }

      #profilePic {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #b57268;
        margin-bottom: 10px;
      }

      .pictext {
        text-align: center;
      }

      .pictext input {
        font-size: 30pt;
        font-family: var(--body-font);
        width: 80%;
        padding: 20px;
        margin: 8px 0;
        border-radius: 8px;
        border: 1px solid #ccc;
      }

      .pictext button {
        background-color: #b57268;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 8px;
      }

      label {
        font-size: 50pt;
        font-family: var(--header-font);
      }

      #savepic {
        width: 200px;
        font-size: 30pt;
        font-family: var(--body-font);
        font-weight: bold;
        border: 2px solid #4a2b30;
        border-radius: 20px;
        padding: 13px;
        margin-top: 0.5em;
        text-align: center;
        background-color: var(--accent-color);
        color: #362830;
        box-shadow: 0 4px 20px rgba(78, 22, 45, 0.25);
      }
    </style>
    <link href="https://fonts.cdnfonts.com/css/oooh-baby" rel="stylesheet" />
    <link href="https://fonts.cdnfonts.com/css/inria-serif" rel="stylesheet" />
    <link
      href="https://fonts.cdnfonts.com/css/cormorant-garamond"
      rel="stylesheet"
    />
    <link href="https://fonts.cdnfonts.com/css/quicksand" rel="stylesheet" />
  </head>

  <body>
    <header>
      <h1 id="plannerName">Settings</h1>
      <div id="backarrow" onclick="window.history.back()">
        <img src="../img/up-arrow.png" width="110px" />
      </div>
    </header>

    <!-- PFP SECTION -->
    <div class="profilepicwrapper">
      <img id="profilePic" src="./img/defaultprofile.png" />
      <div class="pictext">
        <label for="newpicinput">Add Imgur Link:</label>
        <input
          type="text"
          id="newpicinput"
          placeholder="https://i.imgur.com/..."
        />
        <br />
        <button id="savepic">Save</button>
      </div>
    </div>

    <!-- PROFILE SETTINGS SECTION -->
    <div class="wrapperforprofilesection">
      <p id="profilesectiontitle">PROFILE</p>
    </div>
    <div class="profilebox">
      <p id="settingstitle">Edit Name:</p>
      <input type="text" id="usernameInput" />

      <p id="settingstitle">Edit Email:</p>
      <input type="text" id="emailInput" />

      <div id="buttons">
        <button id="editbutton">Edit</button>
        <button id="savebutton">Save</button>
      </div>

      <button id="logoutbutton">Log Out</button>
    </div>

    <!-- APPEARANCE SETTINGS SECTION -->
    <div class="wrapperforapperancesection">
      <p id="profilesectiontitle">APPEARANCE</p>
    </div>
    <div class="profilebox">
      <div class="accentcolorsection">
        <p id="settingstitle">Choose Accent Color:</p>
        <div class="colorpickerwheel">
          <input
            type="color"
            id="accentColor"
            name="accentColor"
            value="#b57268"
          />
        </div>
        <br />
        <button id="restoreColor">Default Color</button>
      </div>

      <div class="allfontbuttons">
        <div class="fontsection">
          <p id="settingstitle">
            <img src="../img/texticon.png" width="100px" /> Font:
          </p>
        </div>
        <button class="fontbutton" id="fontOptionOne">Fancy</button>
        <button class="fontbutton" id="fontOptionTwo">Mono</button>
        <button class="fontbutton" id="fontOptionThree">Default</button>
      </div>
    </div>

    <!-- BOTTOM NAVBAR -->
    <div class="bottomnav">
      <ul>
        <li>
          <a href="friends.html"><img src="../img/friendsicon.png" /></a>
          <span>Friends</span>
        </li>
        <li>
          <a href="sofiascalendar.html"
            ><img src="../img/scheduleicon.png"
          /></a>
          <span>Schedule</span>
        </li>
      </ul>
    </div>

    <script type="module">
      import { db, auth } from "./FirebaseInstances.js";
      import {
        doc,
        getDoc,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

      const nameInput = document.getElementById("usernameInput");
      const emailInput = document.getElementById("emailInput");
      const logoutButton = document.getElementById("logoutbutton");
      const editButton = document.getElementById("editbutton");
      const colorPicker = document.getElementById("accentColor");
      const defaultAccentColor = "#fff5fa";

      nameInput.disabled = true;
      emailInput.disabled = true;

      function setPlaceholder(el, text) {
        if (!el) return;
        el.placeholder = text ?? "";
      }

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          console.log("No user logged in");
          return;
        }

        const userDocRef = doc(db, "users", user.uid);

        // Load Firestore doc and profile data
        try {
          const snap = await getDoc(userDocRef);
          if (snap.exists()) {
            const data = snap.data();

            // Profile Picture
            if (data?.profilePic) {
              document.getElementById("profilePic").src = data.profilePic;
            }

            // USERNAME (changed from name → username)
            if (
              typeof data?.username === "string" &&
              data.username.trim() !== ""
            ) {
              nameInput.value = data.username;
              setPlaceholder(nameInput, data.username);
            }

            // EMAIL
            if (typeof data?.email === "string" && data.email.trim() !== "") {
              emailInput.value = data.email;
              setPlaceholder(emailInput, data.email);
            }
          }
        } catch (err) {
          console.error("Error fetching user doc:", err);
        }

        // Fallbacks
        const authEmail = user.email || null;

        if (!nameInput.value) {
          setPlaceholder(nameInput, "Choose a username");
        }

        if (!emailInput.value && authEmail) {
          emailInput.value = authEmail;
          setPlaceholder(emailInput, authEmail);
        } else {
          setPlaceholder(
            emailInput,
            emailInput.placeholder || authEmail || "you@example.com"
          );
        }

        // Save profile picture
        document
          .getElementById("savepic")
          .addEventListener("click", async () => {
            const newpicinput = document
              .getElementById("newpicinput")
              .value.trim();
            if (!newpicinput) return;

            try {
              await updateDoc(userDocRef, { profilePic: newpicinput });
              document.getElementById("profilePic").src = newpicinput;
              alert("Profile picture updated!");
            } catch (err) {
              console.error("Failed to update profile picture:", err);
              alert("Failed to update profile picture.");
            }
          });

        // Edit button enables inputs
        editButton.addEventListener("click", () => {
          nameInput.disabled = false;
          emailInput.disabled = false;
          nameInput.focus();
        });

        // Save button writes USERNAME + EMAIL to Firestore
        document
          .getElementById("savebutton")
          .addEventListener("click", async () => {
            const username = nameInput.value.trim();
            const email = emailInput.value.trim();

            const updates = {};
            if (username) updates.username = username; // ✅ changed
            if (email) updates.email = email;

            if (Object.keys(updates).length === 0) {
              console.log("No fields to update.");
            } else {
              try {
                await updateDoc(userDocRef, updates);
              } catch (err) {
                console.error("Failed to update user document:", err);
                alert("Failed to save profile info.");
              }
            }

            nameInput.disabled = true;
            emailInput.disabled = true;

            // Update UI
            if (updates.username) {
              nameInput.value = updates.username;
              setPlaceholder(nameInput, updates.username);
            }
            if (updates.email) {
              emailInput.value = updates.email;
              setPlaceholder(emailInput, updates.email);
            }
          });
      });
    </script>
  </body>
</html>
