<html>
  <head>
    <style>
      :root {
        --accent-color: #fff5fa; /* default accent color */
        --header-font: "Oooh Baby", sans-serif;
        --body-font: "Inria Serif", sans-serif;
      }

      body {
        background-color: #fbf7f8;
        text-align: center;
        font-family: var(--header-font);
        font-size: 30pt;
      }

      header {
        background-image: url("../img/lightcoloredbackdrop.png");
        box-shadow: 0 0 60px rgba(78, 22, 45, 0.3);
        padding: 2.5rem 0 0.5rem 0; /* top right bottom left padding*/
      }

      #backarrow {
        position: absolute;
        top: 4rem;
        left: 2rem;
        z-index: 10;
        width: 2rem;
        height: auto;
        cursor: pointer;
      }

      /* styles the bottom navbar */
      .bottomnav {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: var(--accent-color);
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
        z-index: 100;
        padding: 1rem 0;
      }

      .bottomnav ul {
        display: flex;
        justify-content: space-around;
        align-items: center;
        margin: 0;
        padding: 0;
        list-style: none;
      }

      .bottomnav li {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-family: var(--body-font);
        font-size: 25pt;
        color: #362830;
      }

      .bottomnav img {
        width: 100px;
        height: auto;
        margin-bottom: 0.5rem;
      }

      /* styles the container of the PROFILE title */
      .wrapperforprofilesection {
        display: flex;
        align-items: flex-start;
        max-width: 200px;
        border: 2px solid #cecece81;
        border-radius: 20px;
        padding: 8px 8px;
        background-color: rgba(255, 255, 255, 0.774);
        margin-left: 1em;
        margin-top: 1em;
      }

      /* styles the PROFILE title itself */
      #profilesectiontitle {
        text-align: left;
        font-family: var(--body-font);
        font-size: 36pt;
        font-weight: bold;
        margin: 0;
      }

      /* styles the profile box with the name and email */
      .profilebox {
        margin-top: 0;
        width: 100%;
        box-shadow: 0 4px 60px rgba(78, 22, 45, 0.568);
        font-family: var(--body-font);
        display: flex;
        flex-direction: column;
        gap: 16px;
        text-align: left;
        max-width: 800px;
        margin: 7px 0 40px 40px; /*top right bottom left padding (the top padding controls the spacing between the profile title and profile box*/
        padding: 24px;
        border: 2px solid #4a2b30;
        border-radius: 16px;
        background-color: #fffdfc;
      }

      /* styles the headings within the profile box: Edit Name:, Edit Email:  */
      #settingstitle {
        font-weight: bold;
        margin-bottom: 4px;
        font-size: 35pt;
        color: #4a2b30;
      }

      /* styles the input boxes within the profile box */
      .profilebox input[type="text"] {
        padding: 10px;
        border: 1.5px solid #b57268;
        border-radius: 8px;
        font-size: 35pt;
        font-family: inherit;
      }

      /* styles the logout button */
      #logoutbutton,
      #editbutton,
      #savebutton {
        border: none;
        border-radius: 14px;
        font-size: 30pt;
        text-align: left;
        font-family: var(--body-font);
        margin-top: 0.5em;
        width: 190px;
        padding: 20px;
        background-color: #a58a91;
        color: white;
      }

      /* styles the container for the APPEARANCE title */
      .wrapperforapperancesection {
        display: flex;
        align-items: flex-start;
        max-width: 300px;
        border: 2px solid #cecece81;
        border-radius: 20px;
        padding: 8px 8px;
        background-color: rgba(255, 255, 255, 0.774);
        margin-left: 1em;
        margin-top: 1em;
      }

      /* styles the container for the color wheel; mostly creates the border and spacing */
      .colorpickerwheel {
        display: flex;
        flex-direction: row;
        gap: 8px;
        margin-top: 16px;
        padding: 12px;
        border: 2px solid #b5b5b5;
        border-radius: 12px;
        background-color: rgba(255, 255, 255, 0.8);
        max-width: 300px;
        font-family: var(--body-font);
      }

      /* styles the actual color input itself */
      .colorpickerwheel [type="color"] {
        width: 100%;
        height: 40px;
        border: none;
        padding: 0;
        background: none;
      }

      /* styles the default accent color button */
      #restoreColor {
        margin-top: -3em;
        margin-right: 2.5em;
        float: right;
        font-family: var(--body-font);
        color: white;
        background-color: #a58a91;
        padding: 8px 16px;
        color: #ffffff;
        border: 1.5px solid #b5b5b5;
        border-radius: 20px;
        font-size: 30pt;
      }

      /* styles the font icon beside the Font section with the 3 buttons */
      .fontsection img {
        display: inline-block;
        vertical-align: middle;
        padding: 13px;
        margin-top: -1em;
      }

      /* styles all three font buttons at once */
      .fontbutton {
        height: 100px;
        width: 16%;
        line-height: 1;
        margin: 8px;
        font-size: 20pt;
        border: 1px solid #ccc;
        border-radius: 6px;
        background-color: #f5f5f5;
        white-space: nowrap;
      }

      /* styles the container holding the three buttons to align them in the same row */
      .allfontbuttons {
        display: flex;
        gap: 1em;
        flex-wrap: wrap;
      }

      #fontOptionOne {
        font-family: "Cormorant Garamond", sans-serif;
        font-size: 35pt;
      }

      #fontOptionTwo {
        font-family: "Quicksand Book", sans-serif;
        font-size: 30pt;
      }

      #fontOptionThree {
        font-family: "Oooh Baby", sans-serif;
        font-size: 28pt;
      }
    </style>
    <link href="https://fonts.cdnfonts.com/css/oooh-baby" rel="stylesheet" />
    <link href="https://fonts.cdnfonts.com/css/inria-serif" rel="stylesheet" />
    <link
      href="https://fonts.cdnfonts.com/css/cormorant-garamond"
      rel="stylesheet"
    />
    <link href="https://fonts.cdnfonts.com/css/quicksand" rel="stylesheet" />
  </head>

  <body>
    <header>
      <h1 id="plannerName">Settings</h1>
      <div id="backarrow" onclick="window.history.back()">
        <img src="../img/up-arrow.png" width="110px" />
      </div>
    </header>

    <!-- PROFILE SETTINGS SECTION -->
    <div class="wrapperforprofilesection">
      <p id="profilesectiontitle">PROFILE</p>
    </div>
    <div class="profilebox">
      <div id="editable">
        <p id="settingstitle">Edit Name:</p>
        <input type="text" id="nameInput" placeholder="" />

        <p id="settingstitle">Edit Email:</p>
        <input type="text" id="emailInput" placeholder="" />
      </div>
      <div id="buttons">
        <button id="editbutton">Edit</button>
        <button id="savebutton">Save</button>
      </div>
      <button id="logoutbutton">Log Out</button>
    </div>

    <!-- APPEARANCE SETTINGS SECTION -->
    <div class="wrapperforapperancesection">
      <p id="profilesectiontitle">APPEARANCE</p>
    </div>
    <div class="profilebox">
      <div class="accentcolorsection">
        <p id="settingstitle">Choose Accent Color:</p>
        <div class="colorpickerwheel">
          <input
            type="color"
            id="accentColor"
            name="accentColor"
            value="#b57268"
          />
        </div>
        <br />
        <button id="restoreColor">Default Color</button>
      </div>

      <div class="allfontbuttons">
        <div class="fontsection">
          <p id="settingstitle">
            <img src="../img/texticon.png" width="100px" /> Font:
          </p>
        </div>
        <button class="fontbutton" id="fontOptionOne">Fancy</button>
        <button class="fontbutton" id="fontOptionTwo">Mono</button>
        <button class="fontbutton" id="fontOptionThree">Default</button>
      </div>
    </div>

    <!-- BOTTOM NAVBAR -->
    <div class="bottomnav">
      <ul>
        <li>
          <a href="friends.html"><img src="../img/friendsicon.png" /></a>
          <span>Friends</span>
        </li>
        <li>
          <a href="sofiascalendar.html"
            ><img src="../img/scheduleicon.png"
          /></a>
          <span>Schedule</span>
        </li>
      </ul>
    </div>

    <script type="module">
      // CDN imports (works whether you're using a dev server or static hosting)
      import {
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
      import {
        doc,
        setDoc,
        getDoc,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
      // your local file exports (make sure this path is served by your server)
      import { firebaseAuth, firebaseDb } from "/js/FirebaseInstances.js";

      // UI refs
      const nameInput = document.getElementById("nameInput");
      const emailInput = document.getElementById("emailInput");
      const logoutButton = document.getElementById("logoutbutton");
      const editButton = document.getElementById("editbutton");
      const colorPicker = document.getElementById("accentColor");
      const defaultAccentColor = "#fff5fa";

      nameInput.disabled = true;
      emailInput.disabled = true;
      // safe DOM checks
      function setPlaceholder(el, text) {
        if (!el) return;
        el.placeholder = text ?? "";
      }

      // load placeholders from auth first, then overwrite with Firestore doc if available
      onAuthStateChanged(firebaseAuth, async (fbUser) => {
        if (!fbUser) {
          console.log("No user logged in");
          // optional: redirect to login
          // window.location.href = "loginpage.html";
          return;
        }

        // 1) immediate fallback from auth profile
        const authName = fbUser.displayName || null;
        const authEmail = fbUser.email || null;
        // set placeholder fallbacks
        setPlaceholder(nameInput, authName || "Your name");
        setPlaceholder(emailInput, authEmail || "you@example.com");

        // 2) try to get a richer profile from Firestore and overwrite input values/placeholders
        try {
          const userRef = doc(firebaseDb, "users", fbUser.uid);
          const snap = await getDoc(userRef);
          if (snap.exists()) {
            const data = snap.data();
            // If Firestore has a stored name/email, show it in the input value (so it's visible on load)
            if (typeof data?.name === "string" && data.name.trim() !== "") {
              nameInput.value = data.name;
              setPlaceholder(nameInput, data.name);
            } else if (authName) {
              // fallback to auth displayName if Firestore doesn't have a usable value
              nameInput.value = authName;
              setPlaceholder(nameInput, authName);
            }

            if (typeof data?.email === "string" && data.email.trim() !== "") {
              emailInput.value = data.email;
              setPlaceholder(emailInput, data.email);
            } else if (authEmail) {
              emailInput.value = authEmail;
              setPlaceholder(emailInput, authEmail);
            }
          } else {
            // no user doc — use auth values if present
            if (authName) nameInput.value = authName;
            if (authEmail) emailInput.value = authEmail;
          }
        } catch (err) {
          console.error("Error fetching user doc:", err);
          // on error, still show auth values if available
          if (authName) nameInput.value = authName;
          if (authEmail) emailInput.value = authEmail;
        }
      });

      document
        .querySelector("#editbutton")
        .addEventListener("click", editUserInfo);
      function editUserInfo() {
        //Enable the form fields
        nameInput.disabled = false;
        emailInput.disabled = false;
      }

      //-------------------------------------------------------------
      // Function to save updated user info from the profile form
      //-------------------------------------------------------------
      document
        .querySelector("#savebutton")
        .addEventListener("click", saveUserInfo); //Add event listener for save button
      async function saveUserInfo() {
        const user = firebaseAuth.currentUser; // ✅ get the currently logged-in user
        if (!user) {
          alert("No user is signed in. Please log in first.");
          return;
        }
        const name = document.getElementById("nameInput").value; //get the value of the field with id="nameInput"
        const email = document.getElementById("emailInput").value; //get the value of the field with id="emailInput"
        //b) update user's document in Firestore (only non-empty fields will be written)
        await updateUserDocument(user.uid, name, email);
        //c) disable edit and update inputs to reflect saved values
        nameInput.disabled = true;
        emailInput.disabled = true;
        // If the user provided a non-empty value, show it in the input; otherwise keep existing value
        if (typeof name === "string" && name.trim() !== "") {
          nameInput.value = name.trim();
          setPlaceholder(nameInput, name.trim());
        }
        if (typeof email === "string" && email.trim() !== "") {
          emailInput.value = email.trim();
          setPlaceholder(emailInput, email.trim());
        }
      }
      // logout
      if (logoutButton) {
        logoutButton.addEventListener("click", () => {
          signOut(firebaseAuth).then(
            () => (window.location.href = "loginpage.html")
          );
        });
      }

      // accent color logic (kept from your file)
      const savedColor = localStorage.getItem("accentColor");
      if (savedColor) {
        document.documentElement.style.setProperty(
          "--accent-color",
          savedColor
        );
        if (colorPicker) colorPicker.value = savedColor;
      }
      if (colorPicker) {
        colorPicker.addEventListener("input", (e) => {
          const selectedColor = e.target.value;
          document.documentElement.style.setProperty(
            "--accent-color",
            selectedColor
          );
          localStorage.setItem("accentColor", selectedColor);
        });
      }
      const restoreButton = document.getElementById("restoreColor");
      if (restoreButton) {
        restoreButton.addEventListener("click", () => {
          document.documentElement.style.setProperty(
            "--accent-color",
            defaultAccentColor
          );
          localStorage.setItem("accentColor", defaultAccentColor);
          if (colorPicker) colorPicker.value = defaultAccentColor;
        });
      }
      async function updateUserDocument(uid, name, email) {
        const userRef = doc(firebaseDb, "users", uid);

        // Build an updates object containing only non-empty fields.
        const updates = {};
        if (typeof name === "string" && name.trim() !== "")
          updates.name = name.trim();
        if (typeof email === "string" && email.trim() !== "")
          updates.email = email.trim();

        // If there is nothing to update, do nothing.
        if (Object.keys(updates).length === 0) {
          console.log(
            "No non-empty fields to update; skipping Firestore write."
          );
          return;
        }

        try {
          const snap = await getDoc(userRef);

          if (snap.exists()) {
            // document exists → update only provided fields
            await updateDoc(userRef, updates);
            console.log("User profile updated (partial)!");
          } else {
            // document does NOT exist → create it with provided fields
            await setDoc(userRef, updates);
            console.log("User profile created with provided fields!");
          }
        } catch (error) {
          console.error("Error updating/creating user document:", error);
        }
      }
    </script>
  </body>
</html>
